version: "3.8"

services:
  vpn:
    image: qmcgaw/gluetun
    container_name: vpn
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    environment:
      - VPN_SERVICE_PROVIDER=protonvpn
      - VPN_TYPE=openvpn
      - OPENVPN_USER=${OPENVPN_USER}
      - OPENVPN_PASSWORD=${OPENVPN_PASSWORD}
      - SERVER_COUNTRIES=Netherlands
      # ❌ REMOVE THIS — you're paying for ProtonVPN!
      # - FREE_ONLY=on

      # ✅ DNS Fixes
      - DOT=off # Disable DNS-over-TLS (can cause timeouts)
      - DNS_ADDRESS=1.1.1.1 # Use Cloudflare as primary DNS
      - DNS_KEEP_NAMESERVER=on # Keep the DNS server even if VPN pushes its own
      - BLOCK_MALICIOUS=off # Disable block list downloading (this is what's failing!)
      - BLOCK_SURVEILLANCE=off # Disable block list downloading
      - BLOCK_ADS=off # Disable block list downloading
      # ✅ Health/reconnect
      - HEALTH_VPN_DURATION_INITIAL=10s
      - HEALTH_VPN_DURATION_ADDITION=5s
      - HEALTH_SUCCESS_WAIT_DURATION=5s
    dns:
      - 1.1.1.1 # Cloudflare
      - 8.8.8.8 # Google (fallback)

    volumes:
      - gluetun-data:/gluetun

    restart: always

    healthcheck:
      test: ["CMD", "/gluetun-entrypoint", "healthcheck"]
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 30s

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  poly-bot:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: poly-trading-bot

    # Use VPN network - all traffic goes through ProtonVPN
    network_mode: "service:vpn"

    restart: always

    environment:
      # Polymarket Bot Configuration
      - PRIVATE_KEY=${PRIVATE_KEY}
      - SIGNATURE_TYPE=${SIGNATURE_TYPE:-1}
      - FUNDER_ADDRESS=${FUNDER_ADDRESS}
      - MOCK_MODE=${MOCK_MODE:-false}

      # Node Environment
      - NODE_ENV=production
      - TZ=UTC

    env_file:
      - .env

    depends_on:
      vpn:
        condition: service_healthy

    volumes:
      # Mount logs directory for persistent logging
      - ./logs:/app/logs

      # Optional: mount .env for easy config changes
      - ./.env:/app/.env:ro

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
volumes:
  gluetun-data:
